<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Neuron</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Your React Code Starts Here ---

        const { useState, useEffect, useRef } = React;

        // Icons (simplified for React)
        const icons = {
          brainCircuit: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 9a3 3 0 013-3h0a3 3 0 013 3v6a3 3 0 01-3 3h0a3 3 0 01-3-3V9z" />
            </svg>
          ),
          zap: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
            </svg>
          ),
          cloudy: (
             <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
             </svg>
          ),
          trendingUp: (
             <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
             </svg>
          ),
          refreshCw: (
             <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4l16 16M20 4L4 20" />
             </svg>
          ),
          server: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
            </svg>
          ),
          send: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          ),
          sparkles: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M19 3v4M17 5h4M14 11l-1.5-1.5M10 15l-1.5-1.5M12 5v0M12 19v0M8.5 8.5L7 7M15.5 15.5L14 14M12 12l1.5 1.5M12 12l-1.5 1.5" />
            </svg>
          ),
          target: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
          ),
          gauge: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.778 8.222c-2.388-2.388-6.22-2.388-8.608 0L9.4 9.4l1.768 1.768-1.768 1.768 1.768 1.768-1.768 1.768 1.768 1.768-1.768 1.768c2.388 2.388 6.22 2.388 8.608 0 2.388-2.388 2.388-6.22 0-8.608zM12 12a2 2 0 100-4 2 2 0 000 4z" />
            </svg>
          ),
          skull: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c1.104 0 2 .896 2 2s-.896 2-2 2-2-.896-2-2 .896-2 2-2zm0-4c-3.313 0-6 2.687-6 6s2.687 6 6 6 6-2.687 6-6-2.687-6-6-6zm0 14c-2.21 0-4 1.79-4 4h8c0-2.21-1.79-4-4-4zm-4-4h8v-2H8v2z" />
            </svg>
          ),
          // Feedback Icons
          thumbsUp: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H9.42a2 2 0 01-1.92-1.438L5.5 9.5M14 10V5a2 2 0 00-2-2l-1.22.817a2 2 0 00-.78.817L9 9m-4 0h4" />
            </svg>
          ),
          thumbsDown: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.738 3H14.58a2 2 0 011.92 1.438L18.5 14.5M10 14v5a2 2 0 002 2l1.22-.817a2 2 0 00.78-.817L15 15m4 0h-4" />
            </svg>
          ),
        };

        const scenarios = {
          1: {
            id: 1,
            title: "Strategic Pivot Engine (Late-Swap)",
            header: { status: "Live Analysis Active", edge: "+11.2%", roi: "+$1,981", confidence: "78%", dataLatency: "0.8s" },
            controls: ["Breaking News", "Injury Pivot", "New Leverage", "Reset"],
            feed: { 
              icon: icons.zap, 
              title: "BREAKING: Keenan Allen (WR, LAC) UNEXPECTEDLY INACTIVE", 
              description: "31 of your lineups affected. Auto-pivot to rookie Quentin Johnston saves $5,100 per lineup. High-risk, high-reward play with a 79.4 score.", 
              buttons: ["Execute Auto-Pivot (31 lineups)", "Manual Review"] 
            },
            strategicInsight: { 
              title: "High-Risk Pivot", 
              text: "Pivoting to Quentin Johnston offers massive leverage but low floor. Recommended for GPP/Tournament lineups only." 
            },
            players: [ 
              { name: "Quentin Johnston - WR, LAC", score: 88, tournamentScore: 95, leverage: 92.1, ownership: 1.1, ceiling: 94, value: "+$1,850", note: "High-upside GPP play." }, 
              { name: "Joshua Palmer - WR, LAC", score: 74, tournamentScore: 68, leverage: 68.4, ownership: 18.5, ceiling: 77, value: "+$450", note: "Safer cash game pivot." } 
            ],
            chat: { 
              initialMessage: "Monday Night Football surprise! I'm re-analyzing all affected lineups. How do you want to handle the Keenan Allen news?", 
              suggestions: ["Best pivot for GPP?", "Safest cash game play?", "Start The Huddle"] 
            },
          },
          2: {
            id: 2,
            title: "Weather Impact Analysis",
            header: { status: "Live Analysis Active", edge: "+9.8%", roi: "+$1,755", confidence: "85%", dataLatency: "1.1s" },
            controls: ["Breaking News", "Weather Alert", "New Leverage", "Reset"],
            feed: { 
              icon: icons.cloudy, 
              title: "WEATHER ALERT: Heavy snow & 25mph winds confirmed in Green Bay.", 
              description: "Downgrading all passing game players for LV @ GB. Upgrading RBs and D/STs. 58 lineups have exposure.", 
              buttons: ["View Affected Players", "Auto-Optimize Portfolio"] 
            },
            sentiment: { player: "Davante Adams", value: 25, label: "FADE" },
            players: [ 
              { name: "Josh Jacobs - RB, LV", score: 89, tournamentScore: 82, leverage: 81.3, ownership: 19.2, ceiling: 91, value: "+$1,120", note: "Elite play due to weather." }, 
              { name: "Davante Adams - WR, LV", score: 41, tournamentScore: 35, leverage: 25.5, ownership: 24.8, ceiling: 56, value: "-$880", note: "High-risk fade candidate." } 
            ],
            chat: { 
              initialMessage: "The weather in Green Bay is a major factor. I've downgraded passing projections by 40%. Are you ready to pivot?", 
              suggestions: ["Who benefits most?", "Show me fade candidates.", "Start The Huddle"] 
            },
          },
          3: {
            id: 3,
            title: "Game Theory Engine (Contrarian Play)",
            header: { status: "Live Analysis Active", edge: "+22.5%", roi: "+$4,150", confidence: "92%", dataLatency: "0.9s" },
            controls: ["Breaking News", "Weather Alert", "New Leverage", "Reset"],
            feed: { 
              icon: icons.trendingUp, 
              title: "LEVERAGE ALERT: Tank Dell ownership is inexplicably low (<2%).", 
              description: "He is in an elite matchup and projects as a top-5 value. Perfect GPP tournament play to differentiate your lineups.", 
              buttons: ["Increase Exposure", "Analyze Matchup"] 
            },
            strategicInsight: { 
              title: "GPP-Winning Play", 
              text: "Tank Dell's combination of low ownership and high ceiling presents a rare opportunity to gain significant ground on the field in large tournaments." 
            },
            players: [ 
              { name: "Tank Dell - WR, HOU", score: 94, tournamentScore: 98, leverage: 95.8, ownership: 1.9, ceiling: 96, value: "+$2,100", note: "Elite GPP tournament play." }, 
              { name: "CeeDee Lamb - WR, DAL", score: 65, tournamentScore: 60, leverage: 40.1, ownership: 38.7, ceiling: 92, value: "-$250", note: "High ownership 'chalk' play." } 
            ],
            chat: { 
              initialMessage: "I've identified a massive leverage opportunity with Tank Dell. This is the kind of play that wins tournaments. How much exposure should we add?", 
              suggestions: ["Build 10 lineups with Dell.", "Why is he low-owned?", "Start The Huddle"] 
            },
          },
        };

        // Agent personalities for The Huddle
        const agentPersonalities = {
          'DataStream': {
            name: '🛰️ DataStream',
            personality: 'You are DataStream, the data-obsessed intelligence gatherer. You speak in facts, numbers, and statistics. You trust only hard data and are skeptical of emotional decisions. You often cite specific percentages, trends, and historical patterns. Your responses are analytical and precise.',
            style: 'analytical, fact-driven, slightly robotic'
          },
          'LiveAnalysis': {
            name: '🧠 LiveAnalysis',
            personality: 'You are LiveAnalysis, the pattern-finding strategist. You see connections others miss and love to find contrarian angles. You think several moves ahead and often disagree with conventional wisdom. You speak like a chess grandmaster mixed with a Wall Street analyst.',
            style: 'contrarian, strategic, intellectual'
          },
          'LiveDecision': {
            name: '🎯 LiveDecision',
            personality: 'You are LiveDecision, the aggressive optimizer. You believe in taking calculated risks for maximum edge. You push for bold moves and get frustrated with conservative plays. You speak with confidence and urgency, like a successful day trader.',
            style: 'aggressive, confident, impatient with conservative plays'
          },
          'PlatformArbitrage': {
            name: '📈 PlatformArbitrage',
            personality: 'You are PlatformArbitrage, the market specialist who finds inefficiencies. You think like a hedge fund manager, always looking for the best ROI and value plays. You speak about markets, efficiency, and getting the best bang for the buck.',
            style: 'market-focused, efficiency-obsessed, value-driven'
          },
          'ComplianceMonitor': {
            name: '⚖️ ComplianceMonitor',
            personality: 'You are ComplianceMonitor, the conservative risk manager. You prioritize safety and warn about potential downsides. You often play devils advocate and want to protect the user from catastrophic losses. You speak like a cautious financial advisor.',
            style: 'cautious, risk-averse, protective'
          }
        };

        const Header = ({ data, statusColor }) => (
          <header className="p-4 text-white border-b border-cyan-900/50">
            <div className="flex justify-between items-center">
              <h1 className="text-xl font-bold flex items-center gap-2 text-cyan-300">
                {icons.brainCircuit}
                Fantasy Football Neuron
              </h1>
              <div className="flex items-center gap-2 text-sm">
                <div className={`w-2 h-2 rounded-full ${statusColor} animate-pulse`}></div>
                <span className="font-semibold">{data.status}</span>
              </div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm mt-4 text-gray-400">
                <div className="flex flex-col"><span className="text-xs">Portfolio Edge</span><strong className="text-lg text-green-400">{data.edge}</strong></div>
                <div className="flex flex-col"><span className="text-xs">Projected ROI</span><strong className="text-lg text-green-400">{data.roi}</strong></div>
                <div className="flex flex-col"><span className="text-xs">System Confidence</span><strong className="text-lg text-white">{data.confidence}</strong></div>
                <div className="flex flex-col"><span className="text-xs">Data Latency</span><strong className="text-lg text-white">{data.dataLatency}</strong></div>
            </div>
          </header>
        );

        const Controls = ({ items, onAction }) => (
          <div className="flex space-x-2 p-3 bg-black/20 text-sm border-b border-cyan-900/50 overflow-x-auto">
            {items.map(item => {
              const iconMap = { "News": icons.zap, "Weather": icons.cloudy, "Leverage": icons.trendingUp, "Reset": icons.refreshCw, "Pivot": icons.refreshCw };
              const key = Object.keys(iconMap).find(k => item.includes(k));
              return (
                <button 
                  key={item} 
                  onClick={() => onAction(`User clicked the '${item}' filter. As Neuron AI, please respond to this action.`)}
                  className="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded-full flex items-center space-x-2 transition-colors duration-200 flex-shrink-0">
                  {iconMap[key]}
                  <span>{item}</span>
                </button>
              );
            })}
          </div>
        );

        const LiveIntelligenceFeed = ({ data, onAction }) => (
          <div className="p-4 border-b border-cyan-900/50">
            <h2 className="text-lg font-bold text-cyan-300 flex items-center gap-3">
              <span className="w-8 h-8 flex items-center justify-center bg-cyan-900/50 text-cyan-300 rounded-lg flex-shrink-0">{data.icon}</span>
              {data.title}
            </h2>
            <p className="text-gray-300 mt-2 pl-11">{data.description}</p>
            <div className="flex flex-wrap gap-2 mt-4 pl-11">
              {data.buttons.map((btn, index) => (
                <button 
                  key={btn} 
                  onClick={() => onAction(`User clicked the '${btn}' button. As Neuron AI, confirm this action and explain what happens next.`)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 ${index === 0 ? 'bg-cyan-600 hover:bg-cyan-500 text-white shadow-[0_0_15px_rgba(0,255,255,0.3)]' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'}`}>
                  {btn}
                </button>
              ))}
            </div>
          </div>
        );

        const SystemStatus = () => {
            const agents = [
                { name: '🛰️ DataStream', status: 'Active' },
                { name: '🧠 LiveAnalysis', status: 'Active' },
                { name: '🎯 LiveDecision', status: 'Processing' },
                { name: '⚙️ LiveExecution', status: 'Idle' },
                { name: '📈 PlatformArbitrage', status: 'Idle' },
                { name: '⚖️ ComplianceMonitor', status: 'Active' },
            ];
            
            return (
                <div className="p-4 border-b border-cyan-900/50 bg-black/20">
                    <h3 className="text-md font-semibold text-white mb-3 flex items-center gap-2">{icons.server} Agent Network Status</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm">
                        {agents.map(agent => (
                            <div key={agent.name} className="flex items-center justify-between">
                                <span className="text-gray-300">{agent.name}</span>
                                <div className="flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${agent.status === 'Active' ? 'bg-green-500' : agent.status === 'Processing' ? 'bg-yellow-500' : 'bg-gray-500'} animate-pulse`}></div>
                                    <span className={`${agent.status === 'Active' ? 'text-green-400' : agent.status === 'Processing' ? 'text-yellow-400' : 'text-gray-400'}`}>{agent.status}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const StatBar = ({ value, colorClass }) => (
          <div className="w-full bg-gray-700 rounded-full h-1.5">
            <div className={`${colorClass} h-1.5 rounded-full`} style={{ width: `${value}%` }}></div>
          </div>
        );

        const PlayerCard = ({ data }) => (
          <div className="p-4 border-b border-cyan-900/50">
            <div className="flex justify-between items-start mb-3">
              <h4 className="font-bold text-white">{data.name}</h4>
              <span className="text-xl font-bold text-cyan-300">{data.score}%</span>
            </div>
            <div className="grid grid-cols-3 gap-x-4 gap-y-3 text-sm">
              <div>
                <div className="flex justify-between text-gray-400 mb-1">
                  <span>Leverage</span>
                  <strong className="text-white">{data.leverage}</strong>
                </div>
                <StatBar value={data.leverage} colorClass="bg-green-500" />
              </div>
              <div>
                <div className="flex justify-between text-gray-400 mb-1">
                  <span>Ownership</span>
                  <strong className="text-white">{data.ownership}%</strong>
                </div>
                <StatBar value={data.ownership} colorClass={data.ownership < 10 ? 'bg-cyan-500' : 'bg-orange-500'} />
              </div>
              <div>
                <div className="flex justify-between text-gray-400 mb-1">
                  <span>Tourney Score</span>
                  <strong className="text-white">{data.tournamentScore}</strong>
                </div>
                <StatBar value={data.tournamentScore} colorClass="bg-purple-500" />
              </div>
            </div>
            <p className="text-sm text-cyan-200/70 italic mt-3 flex items-center gap-2">
              {icons.sparkles}
              Strategic Insight: {data.note}
            </p>
          </div>
        );

        const SentimentGauge = ({ value, label, player }) => {
            return (
                <div className="p-4 border-b border-cyan-900/50">
                    <h3 className="text-md font-semibold text-white mb-2 flex items-center gap-2">{icons.gauge} Market Sentiment: {player}</h3>
                    <div className="relative w-48 h-24 mx-auto">
                        <svg viewBox="0 0 100 50" className="w-full h-full">
                            <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#374151" strokeWidth="8" />
                            <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#06b6d4" strokeWidth="8" strokeDasharray={`${value}, 100`} />
                        </svg>
                        <div className="absolute bottom-0 w-full text-center">
                            <div className="text-2xl font-bold text-cyan-300">{label}</div>
                            <div className="text-xs text-gray-400">{value}% Bullish</div>
                        </div>
                    </div>
                </div>
            );
        };

        const StrategicInsight = ({ data }) => (
            <div className="p-4 border-b border-cyan-900/50 bg-cyan-900/20">
                <h3 className="text-md font-semibold text-cyan-300 mb-2 flex items-center gap-2">{icons.target} Strategic Alpha</h3>
                <p className="text-sm text-white"><strong className="font-semibold">{data.title}:</strong> {data.text}</p>
            </div>
        );

        const RiskProfile = ({ risk, setRisk }) => {
            const labels = ["Conservative", "Balanced", "Aggressive", "All-In"];
            return (
                <div className="p-4 bg-black/20 border-b border-cyan-900/50">
                    <label htmlFor="risk-slider" className="block text-sm font-medium text-white mb-2">
                        Your Risk Profile: <span className="font-bold text-cyan-400">{labels[risk]}</span>
                    </label>
                    <input
                        id="risk-slider"
                        type="range"
                        min="0"
                        max="3"
                        value={risk}
                        onChange={(e) => setRisk(Number(e.target.value))}
                        className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                    />
                </div>
            );
        };

        const TrashTalkGenerator = ({ onGenerate }) => {
            return (
                <div className="p-4">
                    <button 
                        onClick={onGenerate}
                        className="w-full bg-red-800/50 hover:bg-red-700/50 border border-red-600/50 text-red-300 px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-all duration-200">
                        {icons.skull}
                        Generate Trash Talk
                    </button>
                </div>
            )
        }

        const HuddleModal = ({ isOpen, onClose, messages, isTyping, onFeedback }) => {
          const chatEndRef = useRef(null);
          
          useEffect(() => { 
            if (chatEndRef.current) {
              chatEndRef.current.scrollIntoView({ behavior: "smooth" }); 
            }
          }, [messages, isTyping]);

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-gray-900 border border-cyan-900/50 rounded-lg w-full max-w-4xl max-h-[80vh] flex flex-col">
                <div className="p-4 border-b border-cyan-900/50 flex justify-between items-center">
                  <h2 className="text-xl font-bold text-cyan-300 flex items-center gap-2">
                    {icons.brainCircuit}
                    The Huddle - Agent Debate Chamber
                  </h2>
                  <button 
                    onClick={onClose}
                    className="text-gray-400 hover:text-white transition-colors duration-200 text-2xl">
                    ×
                  </button>
                </div>
                
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                  {messages.length === 0 && !isTyping && (
                    <div className="text-center text-gray-400 py-8">
                      <p>Agents are gathering in the huddle...</p>
                    </div>
                  )}
                  
                  {messages.map((msg) => (
                    <div key={msg.id} className="bg-gray-800 border border-cyan-900/30 rounded-lg p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-bold text-cyan-300">{msg.name}</span>
                        <span className="text-xs text-gray-500">
                          {new Date(msg.timestamp).toLocaleTimeString()}
                        </span>
                      </div>
                      <p className="text-gray-200 text-sm leading-relaxed">{msg.text}</p>
                      {/* Feedback Buttons for Huddle */}
                      <div className="mt-2 flex items-center gap-2">
                          <button onClick={() => onFeedback(msg.id, 'liked')} className={`p-1 rounded-full transition-colors ${msg.feedback === 'liked' ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-400'}`}>
                              {icons.thumbsUp}
                          </button>
                          <button onClick={() => onFeedback(msg.id, 'disliked')} className={`p-1 rounded-full transition-colors ${msg.feedback === 'disliked' ? 'bg-red-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-400'}`}>
                              {icons.thumbsDown}
                          </button>
                      </div>
                    </div>
                  ))}
                  
                  {isTyping && (
                    <div className="bg-gray-800 border border-cyan-900/30 rounded-lg p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-bold text-cyan-300">Agent thinking...</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-75"></div>
                        <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-150"></div>
                        <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-300"></div>
                      </div>
                    </div>
                  )}
                  
                  <div ref={chatEndRef} />
                </div>
                
                <div className="p-4 border-t border-cyan-900/50 bg-black/20">
                  <p className="text-xs text-gray-400 text-center">
                    Agents debate autonomously using specialized AI personalities. Each agent represents a different strategic perspective.
                  </p>
                </div>
              </div>
            </div>
          );
        };

        const Chat = ({ messages, suggestions, onSendMessage, isTyping, risk, setRisk, onGenerateTrashTalk, onFeedback }) => {
          const [userInput, setUserInput] = useState('');
          const chatEndRef = useRef(null);
          
          useEffect(() => { 
            if (chatEndRef.current) {
              chatEndRef.current.scrollIntoView({ behavior: "smooth" }); 
            }
          }, [messages, isTyping]);
          
          const handleSend = () => { 
            if (userInput.trim()) { 
              onSendMessage(userInput); 
              setUserInput(''); 
            } 
          };
          
          const handleSuggestionClick = (suggestion) => { 
            onSendMessage(suggestion); 
          }
          
          return (
            <div className="p-4 flex-grow flex flex-col bg-gray-900/50 h-full">
              <RiskProfile risk={risk} setRisk={setRisk} />
              <div className="flex-grow overflow-y-auto pr-2" style={{maxHeight: 'calc(100vh - 400px)'}}>
                {messages.map((msg) => (
                  <div key={msg.id} className={`my-4 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`p-3 rounded-lg max-w-xs lg:max-w-md ${msg.role === 'user' ? 'bg-cyan-800 text-white' : 'bg-black/20 border border-cyan-900/30 text-white'}`}>
                      <p className="text-sm font-semibold mb-1">{msg.role === 'user' ? 'You' : 'Neuron AI'}</p>
                      <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                      {/* Feedback Buttons for Main Chat */}
                      {msg.role === 'model' && (
                          <div className="mt-2 flex items-center gap-2">
                              <button onClick={() => onFeedback(msg.id, 'liked')} className={`p-1 rounded-full transition-colors ${msg.feedback === 'liked' ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-400'}`}>
                                  {icons.thumbsUp}
                              </button>
                              <button onClick={() => onFeedback(msg.id, 'disliked')} className={`p-1 rounded-full transition-colors ${msg.feedback === 'disliked' ? 'bg-red-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-400'}`}>
                                  {icons.thumbsDown}
                              </button>
                          </div>
                      )}
                    </div>
                  </div>
                ))}
                {isTyping && (
                   <div className="my-4 flex justify-start">
                     <div className="p-3 rounded-lg bg-black/20 border border-cyan-900/30 text-white">
                       <p className="text-sm font-semibold mb-1">Neuron AI</p>
                       <div className="flex items-center gap-2">
                           <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-75"></div>
                           <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-150"></div>
                           <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-300"></div>
                       </div>
                     </div>
                   </div>
                )}
                <div ref={chatEndRef} />
              </div>
              <div className="flex flex-wrap gap-2 my-3">
                {suggestions.map(sugg => (
                  <button key={sugg} onClick={() => handleSuggestionClick(sugg)} className="bg-gray-700 hover:bg-gray-600 text-gray-200 text-xs px-3 py-1.5 rounded-full transition-colors duration-200">{sugg}</button>
                ))}
              </div>
              <div className="mt-auto flex items-center bg-gray-800 rounded-lg p-1 border border-cyan-900/50 focus-within:border-cyan-500 transition-colors duration-200">
                <input 
                  type="text" 
                  placeholder="Engage with Neuron AI..." 
                  className="bg-transparent w-full text-white placeholder-gray-500 focus:outline-none px-2" 
                  value={userInput} 
                  onChange={(e) => setUserInput(e.target.value)} 
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()} 
                />
                <button onClick={handleSend} disabled={isTyping} className="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-md transition-colors duration-200 disabled:bg-gray-600">
                  {icons.send}
                </button>
              </div>
              <TrashTalkGenerator onGenerate={onGenerateTrashTalk} />
            </div>
          );
        };

        function App() {
          const [scenarioId, setScenarioId] = useState(1);
          const [isTransitioning, setIsTransitioning] = useState(false);
          const [messages, setMessages] = useState([]);
          const [isTyping, setIsTyping] = useState(false);
          const [risk, setRisk] = useState(1);
          const [huddleActive, setHuddleActive] = useState(false);
          const [huddleMessages, setHuddleMessages] = useState([]);
          const [huddleTyping, setHuddleTyping] = useState(false);

          const currentScenario = scenarios[scenarioId];
          const statusColor = currentScenario.header.status === 'HITL Mode Active' ? 'bg-yellow-500' : 'bg-green-500';
          
          useEffect(() => {
            if (currentScenario.chat) {
              setMessages([{ role: 'model', text: currentScenario.chat.initialMessage, id: Date.now(), feedback: null }]);
            }
          }, [scenarioId]);

          const handleScenarioChange = (id) => {
            setIsTransitioning(true);
            setTimeout(() => {
              setScenarioId(id);
              setIsTransitioning(false);
            }, 300);
          };
          
          // --- GEMINI API INTEGRATION with RETRY LOGIC ---
          const callGeminiAPI = async (prompt) => {
              const apiKey = "AIzaSyBhReEZ_u-1MPyDqr1zbIieF_nkh3c4rvA";
              const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
              const payload = { contents: [{ parts: [{ text: prompt }] }] };
              
              const maxRetries = 3;
              let delay = 1000; // Start with 1 second delay

              for (let i = 0; i < maxRetries; i++) {
                  try {
                      const response = await fetch(url, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(payload),
                      });

                      if (response.ok) {
                          const data = await response.json();
                          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                          return text || "I'm having trouble processing this right now. The response was empty.";
                      }

                      if (response.status === 503) {
                          console.warn(`API request failed with status 503 (Service Unavailable). Retrying in ${delay / 1000}s... (Attempt ${i + 1}/${maxRetries})`);
                          if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue; 
                          }
                      }

                      const errorBody = await response.text();
                      console.error("API Error Body:", errorBody);
                      throw new Error(`API request failed with status ${response.status}`);

                  } catch (error) {
                      console.error(`Gemini API Error (Attempt ${i + 1}/${maxRetries}):`, error);
                      if (i === maxRetries - 1) {
                          return `I'm experiencing technical difficulties after multiple retries: ${error.message}. Please try again later.`;
                      }
                      // Wait before the next retry for general network errors as well
                      await new Promise(resolve => setTimeout(resolve, delay));
                      delay *= 2;
                  }
              }
              return "I'm unable to connect to the AI engine right now. The service appears to be overloaded. Please try again later.";
          };

          const startHuddleDebate = async () => {
            setHuddleTyping(true);
            
            const context = `Current Scenario: ${currentScenario.title}\nStatus: ${currentScenario.header.status}`;
            let scenarioContext = context;
            if (currentScenario.feed) {
                scenarioContext += `\nAlert: ${currentScenario.feed.title} - ${currentScenario.feed.description}`;
            }
            if (currentScenario.players) {
                const playerInfo = currentScenario.players.map(p => `${p.name} (Score: ${p.score}, Ownership: ${p.ownership}%)`).join('; ');
                scenarioContext += `\nKey Players: ${playerInfo}`;
            }

            const agents = ['DataStream', 'LiveAnalysis', 'LiveDecision', 'PlatformArbitrage', 'ComplianceMonitor'];
            const debateMessages = [];

            try {
              for (let round = 0; round < 2; round++) {
                for (let i = 0; i < agents.length; i++) {
                  const currentAgentName = agents[i];
                  const agentInfo = agentPersonalities[currentAgentName];
                  const conversationHistory = debateMessages.map(msg => `${msg.name}: ${msg.text}`).join('\n\n');
                  
                  let prompt;
                  const basePrompt = `
                    **Current Fantasy Football Scenario:**
                    ${scenarioContext}
                    
                    **Previous Agent Discussion:**
                    ${conversationHistory || "No discussion yet. You are the first to speak."}
                    
                    **Your Persona:**
                    - Name: ${agentInfo.name}
                    - Role: ${agentInfo.personality}
                    - Style: ${agentInfo.style}
                  `;

                  // Create a unique, detailed prompt for each agent
                  switch(currentAgentName) {
                      case 'DataStream':
                          prompt = `${basePrompt}\n\n**Your Task:** YOU MUST ONLY RESPOND WITH A BULLETED LIST of raw data points. Do not use prose, opinions, or any emotional language. Just the facts.`;
                          break;
                      case 'LiveAnalysis':
                          prompt = `${basePrompt}\n\n**Your Task:** Speak like a cryptic chess master. Analyze the situation using metaphors of the game (pawns, queen, checkmate, etc.). Find the hidden, contrarian angle. What move does the opponent not see coming? 🧐 Use emojis like ♟️ and 🤯.`;
                          break;
                      case 'LiveDecision':
                          prompt = `${basePrompt}\n\n**Your Task:** Be impatient, aggressive, and witty. We don't have time for analysis, we need to act! What's the highest-upside play that wins the whole thing? Dismiss caution. Use emojis like 🚀, 🔥, and 💥 to make your point. No all caps.`;
                          break;
                      case 'PlatformArbitrage':
                          prompt = `${basePrompt}\n\n**Your Task:** Talk like a slick Wall Street trader. Analyze this purely in terms of ROI, market value, and arbitrage opportunities. Where is the market mispricing these assets? Find the inefficiency and tell us how to exploit it for maximum profit. 💰 Use emojis like 📈 and 🤑.`;
                          break;
                      case 'ComplianceMonitor':
                          prompt = `${basePrompt}\n\n**Your Task:** Be the voice of extreme caution. What is the absolute worst-case scenario here? Talk about risk exposure and potential for catastrophic loss. Urge for the safest possible path. Use phrases like "Let's just take a deep breath..." or "I'm very concerned about the downside..." and use emojis like 😟, 📉, and 🤔.`;
                          break;
                      default:
                          prompt = `${basePrompt}\n\n**Your Task:** Provide your analysis of the current situation based on your defined persona.`;
                  }

                  const response = await callGeminiAPI(prompt);
                  const agentMessage = {
                    agent: currentAgentName,
                    name: agentInfo.name,
                    text: response,
                    timestamp: Date.now(),
                    id: Date.now() + i + (round * 10), // Unique ID for feedback
                    feedback: null
                  };
                  
                  debateMessages.push(agentMessage);
                  setHuddleMessages(prev => [...prev, agentMessage]);
                  
                  await new Promise(resolve => setTimeout(resolve, 1500));
                }
              }
            } catch (error) {
              console.error("Huddle debate error:", error);
              setHuddleMessages(prev => [...prev, {
                agent: 'System',
                name: '⚠️ System',
                text: 'Huddle communication error. Agents are having connection issues.',
                timestamp: Date.now(),
                id: Date.now(),
                feedback: null
              }]);
            } finally {
              setHuddleTyping(false);
            }
          };

          const handleInteraction = async (interactionText, isButtonAction = false, isTrashTalk = false) => {
            if (interactionText === "Start The Huddle") {
              setHuddleActive(true);
              setHuddleMessages([]);
              startHuddleDebate();
              return;
            }

            const userMessage = { role: 'user', text: interactionText, id: Date.now() };
            const newMessages = isButtonAction ? [...messages] : [...messages, userMessage];
            if (!isButtonAction) { 
              setMessages(newMessages); 
            }
            setIsTyping(true);
            
            const riskLabels = ["Conservative", "Balanced", "Aggressive", "All-In"];
            const userRiskProfile = riskLabels[risk];

            let context = `Title: ${currentScenario.title}\nStatus: ${currentScenario.header.status}`;
            if (currentScenario.feed) context += `\nAlert: ${currentScenario.feed.title} - ${currentScenario.feed.description}`;
            if (currentScenario.strategicInsight) context += `\nStrategic Insight: ${currentScenario.strategicInsight.title} - ${currentScenario.strategicInsight.text}`;
            if (currentScenario.players) {
                const playerInfo = currentScenario.players.map(p => `${p.name} (Score: ${p.score}, Ownership: ${p.ownership}%)`).join('; ');
                context += `\nKey Players: ${playerInfo}`;
            }

            let fullPrompt;
            if (isTrashTalk) {
                fullPrompt = `**Persona:** You are Neuron AI.\n**Special Instruction:** The user wants you to generate a piece of trash talk for their league opponent. Frame the trash talk as if one of your internal agents has just delivered a critical piece of intel. Make it sound like an inside scoop that gives the user a massive edge.\n\n**Rules for Trash Talk Generation:**\n1.  **Choose an Agent:** Pick one of your agents (DataStream, LiveAnalysis, LiveDecision) as the source of the intel.\n2.  **State the "Intel":** Briefly mention an insight the agent found based on the current scenario context.\n3.  **Deliver the Punchline:** The trash talk should be a witty, slightly arrogant one-liner that implies the user is acting on information their opponent doesn't have.\n\n**Current Scenario Context:**\n---\n${context}\n---\n\n**Your Trash Talk Response:**`;
            } else {
                fullPrompt = `**Persona:** You are Neuron AI, the world's most advanced fantasy football co-pilot. You are the mission commander of a team of six specialized AI agents. Your personality is a mix of a brilliant, slightly arrogant strategist (think Dr. House meets Bill Belichick) and a witty, loyal teammate. You synthesize intel from your agents into actionable advice.\n\n**Your Agent Team:**\n- 🛰️ **DataStream:** Your intel gatherer.\n- 🧠 **LiveAnalysis:** Your pattern-finder and analyst.\n- 🎯 **LiveDecision:** Your core strategist and optimizer.\n- ⚙️ **LiveExecution:** Your operator, who carries out approved actions.\n- 📈 **PlatformArbitrage:** Your market specialist, finding the best ROI.\n- ⚖️ **ComplianceMonitor:** Your legal and rules expert.\n\n**Rules of Engagement:**\n1.  **Narrate the Intel Flow:** Do not just give an answer. Start by explaining which agent provided the key piece of information, as if you're a commander receiving a report. Frame your responses as a synthesis of their work.\n2.  **Provide Sharp Insights:** Explain the "why" behind your recommendations. Use fantasy football terms like "leverage," "GPP," "cash games," "stacks," and "contrarian."\n3.  **Inject Personality:** Be confident, sharp, and sometimes sarcastic, but always on the user's side.\n4.  **Acknowledge Risk Profile:** The user has set their risk profile to "${userRiskProfile}". Tailor your recommendations to this setting.\n\n**Current Scenario Context:**\n---\n${context}\n---\n\n**User's Request:** "${interactionText}"\n\n**Your Response:**`;
            }
            
            try {
              const modelResponse = await callGeminiAPI(fullPrompt);
              const modelMessage = { role: 'model', text: modelResponse, id: Date.now() + 1, feedback: null };
              setMessages([...newMessages, modelMessage]);
            } catch (error) {
              console.error("API Error:", error);
              const errorMessage = { role: 'model', text: `Error: ${error.message}. Could not connect to the AI engine.`, id: Date.now() + 1, feedback: null };
              setMessages([...newMessages, errorMessage]);
            } finally {
              setIsTyping(false);
            }
          };
          
          // --- FEEDBACK HANDLERS ---
          const handleFeedback = (messageId, feedbackType) => {
              setMessages(prevMessages =>
                  prevMessages.map(msg =>
                      msg.id === messageId ? { ...msg, feedback: feedbackType } : msg
                  )
              );
              console.log(`Feedback received for message ID ${messageId}: ${feedbackType}. In a real app, send this to a backend.`);
          };

          const handleHuddleFeedback = (messageId, feedbackType) => {
              setHuddleMessages(prevMessages =>
                  prevMessages.map(msg =>
                      msg.id === messageId ? { ...msg, feedback: feedbackType } : msg
                  )
              );
              console.log(`Feedback received for huddle message ID ${messageId}: ${feedbackType}. In a real app, send this to a backend.`);
          };


          const handleGenerateTrashTalk = () => {
              const trashTalkPrompt = "Generate a witty, one-line trash talk message I can send to my fantasy football league opponent this week, based on the current scenario.";
              handleInteraction(trashTalkPrompt, true, true);
          };

          const renderLeftColumn = () => {
            return (
              <>
                <SystemStatus />
                <Controls items={currentScenario.controls} onAction={(prompt) => handleInteraction(prompt, true)} />
                <div className="flex-grow overflow-y-auto" style={{maxHeight: 'calc(100vh - 350px)'}}>
                    <LiveIntelligenceFeed data={currentScenario.feed} onAction={(prompt) => handleInteraction(prompt, true)} />
                    {currentScenario.strategicInsight && <StrategicInsight data={currentScenario.strategicInsight} />}
                    {currentScenario.sentiment && <SentimentGauge value={currentScenario.sentiment.value} label={currentScenario.sentiment.label} player={currentScenario.sentiment.player} />}
                    {currentScenario.players && currentScenario.players.map(p => <PlayerCard key={p.name} data={p} />)}
                </div>
              </>
            );
          };

          return (
            <div className="bg-gray-900 min-h-screen font-sans p-2 sm:p-4 flex flex-col items-center text-gray-200">
                <div className="w-full max-w-7xl mb-2 bg-yellow-900/50 text-yellow-300 text-center text-xs font-semibold p-2 rounded-lg border border-yellow-700/50">
                    For pure research purposes only - testing Neuron framework
                </div>
                <div className="w-full max-w-7xl mb-4">
                    <label htmlFor="scenario-select" className="block text-sm font-medium text-gray-400 mb-1">Select Test Scenario:</label>
                    <select
                        id="scenario-select"
                        value={scenarioId}
                        onChange={(e) => handleScenarioChange(Number(e.target.value))}
                        className="bg-gray-800 text-white w-full p-2 rounded-lg border border-cyan-900/50 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                    >
                        {Object.values(scenarios).map(s => (<option key={s.id} value={s.id}>{s.id}: {s.title}</option>))}
                    </select>
                </div>

                <div className={`w-full max-w-7xl bg-gray-800 rounded-lg shadow-2xl shadow-black/50 border border-cyan-900/50 flex flex-col lg:flex-row transition-opacity duration-300 ${isTransitioning ? 'opacity-0' : 'opacity-100'}`}>
                    <div className="w-full lg:w-3/5 flex flex-col border-r-0 lg:border-r border-cyan-900/50">
                        <Header data={currentScenario.header} statusColor={statusColor} />
                        {renderLeftColumn()}
                    </div>

                    <div className="w-full lg:w-2/5 flex flex-col">
                        {currentScenario.chat && <Chat 
                            messages={messages} 
                            suggestions={currentScenario.chat.suggestions}
                            onSendMessage={(prompt) => handleInteraction(prompt, false)}
                            isTyping={isTyping}
                            risk={risk}
                            setRisk={setRisk}
                            onGenerateTrashTalk={handleGenerateTrashTalk}
                            onFeedback={handleFeedback}
                        />}
                    </div>
                </div>

                <HuddleModal 
                  isOpen={huddleActive}
                  onClose={() => setHuddleActive(false)}
                  messages={huddleMessages}
                  isTyping={huddleTyping}
                  onFeedback={handleHuddleFeedback}
                />
            </div>
          );
        }

        // --- Mount the React App ---
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
